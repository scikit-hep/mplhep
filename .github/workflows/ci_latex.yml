# GitHub Actions workflow for testing LaTeX-dependent styles
#
# This workflow tests matplotlib styles that require LaTeX to be installed:
# - CMSTex, ROOTTex (CMS experiment)
# - DUNETex, DUNETex1 (DUNE experiment)
# - ATLASTex (ATLAS experiment)
# - LHCbTex1, LHCbTex2 (LHCb experiment)
#
# These tests are separated from the main CI workflow because:
# 1. LaTeX installation adds ~500MB and several minutes to CI time
# 2. LaTeX rendering can be environment-dependent
# 3. Most PRs don't affect LaTeX-dependent features
#
# The workflow runs:
# - On pull requests that modify style files or LaTeX tests
# - Weekly (every Monday) to catch regressions
# - Manually via workflow_dispatch

name: CI LaTeX

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'src/mplhep/styles/**'
      - 'tests/test_styles_latex.py'
      - 'tests/test_dune.py'
      - '.github/workflows/ci_latex.yml'
  # Run weekly on Monday at 0:00 UTC
  schedule:
    - cron: '0 0 * * 1'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

  test-latex:
    name: "LaTeX Tests â€¢ Python ${{ matrix.python-version }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.12']

    steps:
      - uses: actions/checkout@v6

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          activate-environment: true
          version: 'latest'
          python-version: ${{ matrix.python-version }}
          enable-cache: true
          cache-dependency-glob: '**/pyproject.toml'

      - name: Install core fonts
        run: |
          echo ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true | sudo debconf-set-selections
          sudo apt-get install ttf-mscorefonts-installer

      - name: List available fonts
        run: fc-list | grep -i microsoft || fc-list | grep -i "times new" || echo "Microsoft fonts listing complete"

      - name: Install LaTeX packages
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-latex-extra texlive-fonts-recommended texlive-science tex-gyre dvipng cm-super

      - name: Install package
        run: |
          uv pip install -e '.[all]'
          uv pip install pytest-github-actions-annotate-failures
          uv pip install pytest-xdist
          uv pip list

      - name: Verify LaTeX installation
        run: |
          which latex
          latex --version

      - name: Test LaTeX styles with pytest
        run: |
          python -m pytest tests/test_styles_latex.py -m latex -r sa --mpl --mpl-results-path=pytest_results_latex -n 4 --benchmark-disable

      - name: Test DUNE LaTeX styles with pytest
        run: |
          python -m pytest tests/test_dune.py::test_style_dunetex -m latex -r sa --mpl --mpl-results-path=pytest_results_dune_tex
          python -m pytest tests/test_dune.py::test_style_dunetex1 -m latex -r sa --mpl --mpl-results-path=pytest_results_dune_tex
          python -m pytest tests/test_dune.py::test_dune_style_string_aliases -m latex -r sa --mpl --mpl-results-path=pytest_results_dune_tex

      - name: Upload pytest test results
        uses: actions/upload-artifact@v6
        if: failure()
        with:
          name: pytest_results_latex-${{ matrix.python-version }}
          retention-days: 7
          path: |
            pytest_results_latex
            pytest_results_dune_tex
